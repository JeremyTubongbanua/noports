version: "3"
networks:
  sshnp:
    driver: bridge
    name: atsigncompany/sshnp-e2e-network-sshnp
  sshnpd:
    driver: bridge
    name: atsigncompany/sshnp-e2e-network-sshnpd
services:
  image-runtime-local:
    build:
      context: ../../../
      dockerfile: ./tests/end2end_tests/image/Dockerfile
      target: runtime-local
    image: atsigncompany/sshnp-e2e-runtime:local
    deploy:
      mode: replicated
      replicas: 0
  container-sshnp:
    container_name: sshnp
    volumes:
      - ../contexts/sshnp/keys/:/atsign/.atsign/keys/ # mount keys
      - ../contexts/sshnp/entrypoint.sh:/atsign/entrypoint.sh # mount entrypoint
    networks:
      - sshnp
    # auto added:
    # - image
    # - depends_on: (sshnpd + runtime service)
    image: atsigncompany/sshnp-e2e-runtime:local
    depends_on:
      container-sshnpd:
        condition: service_healthy
      image-runtime-local:
        condition: service_started
  container-sshnpd:
    container_name: sshnpd
    volumes:
      - ../contexts/sshnpd/keys/:/atsign/.atsign/keys/ # mount keys
      - ../contexts/sshnpd/entrypoint.sh:/atsign/entrypoint.sh # mount entrypoint.sh
      - ../contexts/sshnpd/test.sh:/atsign/test.sh # mount test.sh
      - ../contexts/sshnpd/test.txt/:/atsign/test.txt/ # mount test.txt
    networks:
      - sshnpd
    healthcheck:
      test:
        [
          "CMD",
          "grep",
          "-Eq",
          "monitor started for @",
          "/atsign/sshnpd_log.txt",
        ]
      start_period: 10s # Wait 10 seconds before checking
      interval: 5s # Check every 5 seconds
      timeout: 10s # If a check takes longer than a second, consider it a failed check
      retries: 180 # Retry the check 180 times (180 * 5s = 15 mins)
    # auto added:
    # - image
    # - depends_on: (sshrvd + runtime service)
    image: atsigncompany/sshnp-e2e-runtime:local
    depends_on:
      - image-runtime-local
