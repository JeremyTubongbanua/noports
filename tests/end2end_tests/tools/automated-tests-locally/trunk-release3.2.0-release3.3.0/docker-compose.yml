version: '3'

services:
  image-runtime-trunk:
    build:
      context: ../../../../../
      dockerfile: test/end2end_tests/image/Dockerfile
      target: runtime-branch
      args:
        - branch=trunk
    image: atsigncompany/sshnp-e2e-runtime:trunk
    deploy:
      mode: replicated
      replicas: 0
  image-runtime-release3-2-0:
    build:
      context: ../../../image/
      dockerfile: ./Dockerfile
      target: runtime-release
      args:
        - release=3.2.0
    image: atsigncompany/sshnp-e2e-runtime:release3.2.0
    deploy:
      mode: replicated
      replicas: 0
  image-runtime-release3-3-0:
    build:
      context: ../../../image/
      dockerfile: ./Dockerfile
      target: runtime-release
      args:
        - release=3.3.0
    image: atsigncompany/sshnp-e2e-runtime:release3.3.0
    deploy:
      mode: replicated
      replicas: 0
  container-sshnp:
    image: atsigncompany/sshnp-e2e-runtime:trunk
    container_name: sshnp
    volumes:
      - ../../../contexts/sshnp/keys/:/atsign/.atsign/keys/ # mount keys
      - ../../../contexts/sshnp/entrypoint.sh:/atsign/entrypoint.sh # mount entrypoint
    networks:
      - sshnp
    depends_on:
      - image-runtime-trunk
      - container-sshnpd
  container-sshnpd:
    image: atsigncompany/sshnp-e2e-runtime:release3.2.0
    container_name: sshnpd
    volumes:
      - ../../../contexts/sshnpd/keys/:/atsign/.atsign/keys/ # mount keys
      - ../../../contexts/sshnpd/entrypoint.sh:/atsign/entrypoint.sh # mount entrypoint.sh
      - ../../../contexts/sshnpd/test.sh:/atsign/test.sh # mount test.sh
    networks:
      - sshnpd
    depends_on:
      - image-runtime-release3-2-0
      - container-sshrvd
  container-sshrvd:
    image: atsigncompany/sshnp-e2e-runtime:release3.3.0
    container_name: sshrvd
    volumes:
      - ../../../contexts/sshrvd/keys/:/atsign/.atsign/keys/ # mount keys
      - ../../../contexts/sshrvd/entrypoint.sh:/atsign/entrypoint.sh # mount entrypoint
    network_mode: host
    depends_on:
      - image-runtime-release3-3-0

networks:
  sshnp:
    driver: bridge
    name: atsigncompany/sshnp-e2e-network-sshnp
  sshnpd:
    driver: bridge
    name: atsigncompany/sshnp-e2e-network-sshnpd

